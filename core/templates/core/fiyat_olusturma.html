{% extends 'core/base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Fiyat Teklifi Oluşturma</h1>
    </div>

    {% if hata %}
        <div class="alert alert-danger">{{ hata }}</div>
    {% endif %}

    <div class="card shadow-sm border-0 mb-4 bg-light">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" class="row g-3 align-items-end">
                {% csrf_token %}
                <div class="col-md-2">
                    <label class="form-label fw-bold">Hedef Yıl</label>
                    {{ form.yil }}
                </div>
                <div class="col-md-8">
                    <label class="form-label fw-bold">Eski Liste (Opsiyonel)</label>
                    {{ form.dosya }}
                    <div class="form-text">Müşterinin eski listesini yüklerseniz, sistem otomatik zam oranı hesaplar.</div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-gear-fill me-2"></i>Listeyi Hazırla
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if veriler %}
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-secondary fw-bold">Fiyat Listesi Önizleme</h5>
            <button class="btn btn-success" disabled title="Henüz aktif değil">
                <i class="bi bi-file-earmark-excel me-2"></i>Excel İndir
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle mb-0" style="font-size: 0.9rem;">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th style="width: 10%">Kod</th>
                        <th style="width: 35%">Hizmet Adı</th>
                        <th style="width: 12%" class="text-end">Müşteri Eski</th>
                        <th style="width: 12%" class="text-end text-warning">Asgari (Ref)</th>
                        <th style="width: 12%" class="text-center">Artış %</th>
                        <th style="width: 14%" class="text-end">Yeni Teklif</th>
                        <th style="width: 5%" class="text-center">Durum</th>
                    </tr>
                </thead>
                <tbody>
                    {% for satir in veriler %}
                        {% if satir.is_header %}
                            <tr class="table-secondary">
                                <td class="fw-bold text-center bg-warning-subtle">{{ satir.kod }}</td>
                                <td colspan="6" class="fw-bold bg-warning-subtle ps-3">{{ satir.aciklama }}</td>
                            </tr>
                        {% else %}
                            <tr class="veri-satiri {% if satir.durum == 'Yeni Hizmet' %}table-info{% endif %}">
                                <td class="fw-bold text-primary">{{ satir.kod }}</td>
                                <td>{{ satir.hizmet }}</td>
                                
                                <td class="text-end text-muted" data-eski="{{ satir.musteri_eski_fiyat }}">
                                    {% if satir.musteri_eski_fiyat > 0 %}
                                        {{ satir.musteri_eski_fiyat|floatformat:2 }} TL
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>

                                <td class="text-end text-secondary small">
                                    {{ satir.asgari_ucret|floatformat:2 }} TL
                                </td>

                                <td class="p-1">
                                    <input type="number" step="0.01" class="form-control form-control-sm text-center fw-bold text-primary yuzde-input" 
                                           value="{{ satir.uygulanan_artis_yuzde|stringformat:'.2f' }}">
                                </td>

                                <td class="p-1">
                                    <input type="number" step="0.01" class="form-control form-control-sm text-end fw-bold text-success fiyat-input" 
                                           value="{{ satir.onerilen_fiyat|stringformat:'.2f' }}">
                                </td>

                                <td class="text-center">
                                    {% if satir.durum == 'Yeni Hizmet' %}
                                        <span class="badge bg-info text-dark">Yeni</span>
                                    {% elif satir.durum == 'Eşleşen' %}
                                        <span class="badge bg-success">Eşleşti</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Std</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tüm veri satırlarını dinle
        const rows = document.querySelectorAll('.veri-satiri');

        rows.forEach(row => {
            const yuzdeInput = row.querySelector('.yuzde-input');
            const fiyatInput = row.querySelector('.fiyat-input');
            
            // Eski fiyatı al (Eğer 0 ise, hesaplama bazını Asgari Ücret veya mevcut fiyat olarak alacağız)
            // Lojik: Eğer müşteri eski fiyatı varsa baz odur. Yoksa baz yoktur, yüzdeyi fiyattan hesaplarız.
            let bazFiyat = parseFloat(row.querySelector('td[data-eski]').getAttribute('data-eski').replace(',', '.'));
            
            // Eğer eski fiyat yoksa (Yeni Hizmetse), baz fiyat o anki hesaplanan fiyattır (Referans kaybolur)
            // Bu yüzden "Sıfırdan Oluşturma" modunda % değişimi biraz anlamsız olabilir ama yine de formül kuralım.
            const eskiFiyatVar = bazFiyat > 0;

            // 1. Yüzde Değişince -> Fiyatı Güncelle
            yuzdeInput.addEventListener('input', function() {
                if (!eskiFiyatVar) return; // Eski fiyat yoksa yüzde neye göre artacak? (Bu kısıtlamayı konuşabiliriz)

                let yuzde = parseFloat(this.value);
                if (isNaN(yuzde)) yuzde = 0;

                let yeniFiyat = bazFiyat * (1 + (yuzde / 100));
                fiyatInput.value = yeniFiyat.toFixed(2);
            });

            // 2. Fiyat Değişince -> Yüzdeyi Güncelle
            fiyatInput.addEventListener('input', function() {
                let yeniFiyat = parseFloat(this.value);
                if (isNaN(yeniFiyat)) yeniFiyat = 0;

                if (eskiFiyatVar) {
                    // Eski fiyata göre yüzdesini bul: ((Yeni - Eski) / Eski) * 100
                    let yeniYuzde = ((yeniFiyat - bazFiyat) / bazFiyat) * 100;
                    yuzdeInput.value = yeniYuzde.toFixed(2);
                } else {
                    // Eski fiyat yoksa yüzdeyi 0 yap veya boş bırak
                    yuzdeInput.value = 0;
                }
            });
        });
    });
</script>
{% endblock %}