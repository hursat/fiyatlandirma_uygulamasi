{% extends 'core/base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Fiyat Teklifi Oluşturma</h1>
    </div>

    {% if hata %}
        <div class="alert alert-danger">{{ hata }}</div>
    {% endif %}

    <div class="card shadow-sm border-0 mb-4 bg-light">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" class="row g-3 align-items-end">
                {% csrf_token %}
                <div class="col-md-2">
                    <label class="form-label fw-bold">Hedef Yıl</label>
                    {{ form.yil }}
                </div>
                <div class="col-md-8">
                    <label class="form-label fw-bold">Eski Liste (Excel)</label>
                    {{ form.dosya }}
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Hesapla</button>
                </div>
            </form>
        </div>
    </div>

    {% if veriler %}
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="hedef_yil_hidden" value="{{ form.yil.value }}">
        
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-secondary fw-bold">Hesaplanan Liste</h5>
                
                <div class="d-flex gap-2">
                    <input type="text" name="musteri_ismi" class="form-control" placeholder="Müşteri Unvanı Giriniz..." style="min-width: 300px;">
                    
                    <button type="submit" name="excel_indir" class="btn btn-success fw-bold text-nowrap">
                        <i class="bi bi-file-earmark-excel"></i> Excel Olarak İndir
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover table-bordered align-middle mb-0" style="font-size: 0.85rem;">
                    <thead class="table-dark sticky-top text-center">
                        <tr>
                            <th rowspan="2" style="width: 8%">Kod</th>
                            <th rowspan="2" style="width: 30%">Hizmet Adı</th>
                            <th colspan="3" class="bg-secondary">Geçmiş Yıl (Referans)</th>
                            <th colspan="3" class="bg-primary">Hedef Yıl (Teklif)</th>
                        </tr>
                        <tr>
                            <th class="bg-secondary text-light" style="width: 10%">Asgari</th>
                            <th class="bg-secondary text-light" style="width: 10%">Müşteri</th>
                            <th class="bg-secondary text-light" style="width: 8%">Fark %</th>
                            
                            <th class="bg-primary text-light" style="width: 10%">Asgari</th>
                            <th class="bg-primary text-light" style="width: 10%">Fark %</th>
                            <th class="bg-primary text-light" style="width: 14%">Müşteri Fiyat</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for satir in veriler %}
                            {% if satir.is_header %}
                                <tr class="table-secondary">
                                    <td class="fw-bold text-center bg-warning-subtle">{{ satir.kod }}</td>
                                    <td colspan="7" class="fw-bold bg-warning-subtle ps-3">{{ satir.aciklama }}</td>
                                </tr>
                            {% else %}
                                <tr class="veri-satiri {% if satir.durum == 'Eşleşemeyen' %}table-danger{% endif %}">
                                    
                                    <input type="hidden" name="liste_kod[]" value="{{ satir.kod }}">
                                    <input type="hidden" name="liste_hizmet[]" value="{{ satir.hizmet }}">
                                    <input type="hidden" name="liste_durum[]" value="{{ satir.durum }}">
                                    <input type="hidden" name="liste_eski_fiyat[]" value="{{ satir.musteri_eski_fiyat }}">

                                    <td class="fw-bold {% if satir.durum == 'Eşleşemeyen' %}text-danger{% else %}text-primary{% endif %}">
                                        {{ satir.kod }}
                                    </td>
                                    
                                    <td>
                                        {{ satir.hizmet }}
                                        {% if satir.durum == 'Eşleşemeyen' %}
                                            <span class="badge bg-danger ms-2">Eşleşmedi/Kaldırıldı</span>
                                        {% endif %}
                                    </td>

                                    <td class="text-end text-muted">
                                        {% if satir.eski_asgari > 0 %}
                                            {{ satir.eski_asgari|floatformat:2 }}
                                        {% else %}-{% endif %}
                                    </td>
                                    <td class="text-end text-muted">
                                        {% if satir.musteri_eski_fiyat > 0 %}
                                            {{ satir.musteri_eski_fiyat|floatformat:2 }}
                                        {% else %}-{% endif %}
                                    </td>
                                    <td class="text-center text-muted fst-italic">
                                        {% if satir.musteri_eski_fiyat > 0 and satir.eski_asgari > 0 %}
                                            %{{ satir.eski_fark_yuzde|floatformat:1 }}
                                        {% else %}-{% endif %}
                                    </td>

                                    <td class="text-end fw-bold text-dark" data-yeni-asgari="{{ satir.yeni_asgari }}">
                                        {% if satir.yeni_asgari > 0 %}
                                            {{ satir.yeni_asgari|floatformat:2 }}
                                        {% else %}-{% endif %}
                                    </td>

                                    <td class="p-1">
                                        {% if satir.durum != 'Eşleşemeyen' %}
                                            <input type="text" class="form-control form-control-sm text-center fw-bold text-primary fark-input" 
                                                value="{{ satir.yeni_fark_yuzde|stringformat:'.2f' }}">
                                        {% else %}
                                            <span class="text-center d-block">-</span>
                                        {% endif %}
                                    </td>

                                    <td class="p-1">
                                        {% if satir.durum != 'Eşleşemeyen' %}
                                            <input type="text" name="liste_fiyat[]" class="form-control form-control-sm text-end fw-bold text-success fiyat-input" 
                                                value="{{ satir.yeni_musteri_fiyat|stringformat:'.2f' }}">
                                        {% else %}
                                            <span class="text-center d-block">-</span>
                                            <input type="hidden" name="liste_fiyat[]" value="0">
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </form>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const rows = document.querySelectorAll('.veri-satiri');

        rows.forEach(row => {
            const asgariHucre = row.querySelector('td[data-yeni-asgari]');
            const farkInput = row.querySelector('.fark-input');
            const fiyatInput = row.querySelector('.fiyat-input');

            if (!fiyatInput || !asgariHucre) return;

            const asgariUcret = parseFloat(asgariHucre.getAttribute('data-yeni-asgari').replace(',', '.'));

            function yuvarlaBesYukari(val) {
                return Math.ceil(val / 5) * 5;
            }

            farkInput.addEventListener('change', function() {
                let yuzde = parseFloat(this.value);
                if (isNaN(yuzde)) yuzde = 0;

                if (asgariUcret > 0) {
                    let hamFiyat = asgariUcret * (1 + (yuzde / 100));
                    let yuvarlanmisFiyat = yuvarlaBesYukari(hamFiyat);
                    fiyatInput.value = yuvarlanmisFiyat.toFixed(2);
                    let revizeYuzde = ((yuvarlanmisFiyat - asgariUcret) / asgariUcret) * 100;
                    this.value = revizeYuzde.toFixed(2);
                }
            });

            fiyatInput.addEventListener('input', function() {
                let girilenFiyat = parseFloat(this.value);
                if (isNaN(girilenFiyat)) girilenFiyat = 0;

                if (asgariUcret > 0) {
                    let yeniYuzde = ((girilenFiyat - asgariUcret) / asgariUcret) * 100;
                    farkInput.value = yeniYuzde.toFixed(2);
                } else {
                    farkInput.value = 0;
                }
            });
        });
    });
</script>
{% endblock %}