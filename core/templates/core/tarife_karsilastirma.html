{% extends 'core/base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Tarife Karşılaştırma Paneli</h1>
    </div>

    {% if hata %}
        <div class="alert alert-danger shadow-sm">{{ hata }}</div>
    {% endif %}
    {% if mesaj %}
        <div class="alert alert-success shadow-sm">{{ mesaj }}</div>
    {% endif %}

    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" class="row g-2 align-items-end">
                {% csrf_token %}
                <div class="col-md-5">
                    <label class="form-label small fw-bold">Eski Liste</label>
                    {{ form.eski_yil_dosyasi }}
                </div>
                <div class="col-md-5">
                    <label class="form-label small fw-bold">Yeni Liste</label>
                    {{ form.yeni_yil_dosyasi }}
                </div>
                <div class="col-md-2">
                    <button type="submit" name="analiz_et" class="btn btn-primary w-100">Analiz Et</button>
                </div>
            </form>
        </div>
    </div>

    {% if veriler %}
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-secondary fw-bold">Analiz Sonuçları</h5>
            <form method="post">
                {% csrf_token %}
                <button type="submit" name="kaydet" class="btn btn-success fw-bold px-4">
                    Veritabanına Kaydet
                </button>
            </form>
        </div>

        <div class="table-responsive" style="max-height: 700px;">
            <table class="table table-sm table-hover table-bordered mb-0 align-middle" style="font-size: 0.85rem;">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th>Yeni Kod</th>
                        <th>Yeni Hizmet Adı</th>
                        <th class="text-end">Yeni Fiyat</th>
                        <th>Eski Kod</th>
                        <th>Eski Hizmet Adı</th>
                        <th class="text-end">Eski Fiyat</th>
                        <th class="text-end">Fark</th>
                        <th class="text-center">Değişim</th>
                        <th class="text-center">Durum</th>
                    </tr>
                </thead>
                <tbody>
                    {% for satir in veriler %}
                        {% if satir.is_header %}
                            <tr class="table-secondary border-bottom border-dark">
                                <td class="fw-bold fs-5 text-dark bg-warning-subtle text-center border-end border-dark">
                                    {{ satir.kod }}
                                </td>
                                <td colspan="8" class="fw-bold fs-5 text-dark bg-warning-subtle ps-3">
                                    {{ satir.aciklama }}
                                </td>
                            </tr>
                        {% else %}
                            <tr class="{% if satir.Durum == 'Yeni Eklendi' %}table-primary{% elif satir.Durum == 'Listeden Çıkarıldı' %}table-danger{% elif satir.Durum == 'Zamlandı' %}table-success{% endif %}" style="--bs-table-bg-opacity: .1;">
                                
                                <td class="font-monospace fw-bold text-primary">{{ satir.Yeni_Kod }}</td>
                                <td class="fw-semibold">{{ satir.Yeni_Hizmet }}</td>
                                <td class="text-end font-monospace">{{ satir.Yeni_Fiyat }}{% if satir.Yeni_Fiyat != '-' %} TL{% endif %}</td>
                                
                                <td class="font-monospace text-muted">{{ satir.Eski_Kod }}</td>
                                <td class="text-muted small">{{ satir.Eski_Hizmet }}</td>
                                <td class="text-end font-monospace text-muted">{{ satir.Eski_Fiyat }}{% if satir.Eski_Fiyat != '-' %} TL{% endif %}</td>
                                
                                <td class="text-end font-monospace fw-bold">{{ satir.Fark }}{% if satir.Fark != '-' %} TL{% endif %}</td>
                                
                                <td class="text-center font-monospace">
                                    {% if satir.Degisim_Yuzde != '-' %}
                                        <span class="{% if satir.Degisim_Yuzde > 0 %}text-success{% elif satir.Degisim_Yuzde < 0 %}text-danger{% endif %} fw-bold">
                                            %{{ satir.Degisim_Yuzde|floatformat:2 }}
                                        </span>
                                    {% else %}-{% endif %}
                                </td>
                                
                                <td class="text-center">
                                    <span class="badge rounded-pill {% if satir.Durum == 'Yeni Eklendi' %}bg-primary{% elif satir.Durum == 'Listeden Çıkarıldı' %}bg-danger{% elif satir.Durum == 'Değişmedi' %}bg-secondary{% else %}bg-success{% endif %}">
                                        {{ satir.Durum }}
                                    </span>
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}